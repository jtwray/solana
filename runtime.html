<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The Runtime - </title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">var path_to_root = "";</script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><a href="synchronization.html"><strong aria-hidden="true">2.</strong> Synchronization</a></li><li><ol class="section"><li><a href="vdf.html"><strong aria-hidden="true">2.1.</strong> Introduction to VDFs</a></li><li><a href="poh.html"><strong aria-hidden="true">2.2.</strong> Proof of History</a></li></ol></li><li><a href="fullnode.html"><strong aria-hidden="true">3.</strong> Fullnode</a></li><li><ol class="section"><li><a href="tpu.html"><strong aria-hidden="true">3.1.</strong> Tpu</a></li><li><a href="tvu.html"><strong aria-hidden="true">3.2.</strong> Tvu</a></li><li><a href="ncp.html"><strong aria-hidden="true">3.3.</strong> Ncp</a></li><li><a href="jsonrpc-service.html"><strong aria-hidden="true">3.4.</strong> JsonRpcService</a></li></ol></li><li><a href="avalanche.html"><strong aria-hidden="true">4.</strong> Avalanche replication</a></li><li><ol class="section"><li><a href="porep.html"><strong aria-hidden="true">4.1.</strong> Proof of replication</a></li></ol></li><li><a href="programs.html"><strong aria-hidden="true">5.</strong> On-chain programs</a></li><li><ol class="section"><li><a href="runtime.html" class="active"><strong aria-hidden="true">5.1.</strong> The Runtime</a></li><li><a href="ledger.html"><strong aria-hidden="true">5.2.</strong> Ledger format</a></li></ol></li><li><a href="appendix.html"><strong aria-hidden="true">6.</strong> Appendix</a></li><li><ol class="section"><li><a href="terminology.html"><strong aria-hidden="true">6.1.</strong> Terminology</a></li><li><a href="jsonrpc-api.html"><strong aria-hidden="true">6.2.</strong> JSON RPC API</a></li><li><a href="wallet.html"><strong aria-hidden="true">6.3.</strong> solana-wallet CLI</a></li></ol></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title"></h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#runtime" id="runtime"><h1>Runtime</h1></a>
<p>The goal with the runtime is to have a general purpose execution environment
that is highly parallelizable.  To achieve this goal the runtime forces each
Instruction to specify all of its memory dependencies up front, and therefore a
single Instruction cannot cause a dynamic memory allocation.  An explicit
Instruction for memory allocation from the <code>SystemProgram::CreateAccount</code> is
the only way to allocate new memory in the engine.  A Transaction may compose
multiple Instruction, including <code>SystemProgram::CreateAccount</code>, into a single
atomic sequence which allows for memory allocation to achieve a result that is
similar to dynamic allocation.</p>
<a class="header" href="#state" id="state"><h3>State</h3></a>
<p>State is addressed by an Account which is at the moment simply the Pubkey.  Our
goal is to eliminate memory allocation from within the program itself.  Thus
the client of the program provides all the state that is necessary for the
program to execute in the transaction itself.  The runtime interacts with the
program through an entry point with a well defined interface.  The userdata
stored in an Account is an opaque type to the runtime, a <code>Vec&lt;u8&gt;</code>, the
contents of which the program code has full control over.</p>
<p>The Transaction structure specifies a list of Pubkey's and signatures for those
keys and a sequential list of instructions that will operate over the state's
associated with the <code>account_keys</code>.  For the transaction to be committed all
the instructions must execute successfully, if any abort the whole transaction
fails to commit.</p>
<a class="header" href="#account-structure-accounts-maintain-token-state-as-well-as-program-specific" id="account-structure-accounts-maintain-token-state-as-well-as-program-specific"><h3>Account structure Accounts maintain token state as well as program specific</h3></a>
<p>memory.</p>
<a class="header" href="#transaction-engine" id="transaction-engine"><h1>Transaction Engine</h1></a>
<p>At its core, the engine looks up all the Pubkeys maps them to accounts and
routs them to the <code>program_id</code> entry point.</p>
<a class="header" href="#execution" id="execution"><h2>Execution</h2></a>
<p>Transactions are batched and processed in a pipeline</p>
<p><img alt="LAMPORT pipeline" src="img/lamport.svg" class="center"/></p>
<p>At the <code>execute</code> stage, the loaded pages have no data dependencies, so all the
programs can be executed in parallel.</p>
<p>The runtime enforces the following rules:</p>
<ol>
<li>The <code>program_id</code> code is the only code that will modify the contents of
<code>Account::userdata</code> of Account's that have been assigned to it.  This means
that upon assignment userdata vector is guaranteed to be <code>0</code>.</li>
<li>Total balances on all the accounts is equal before and after execution of a
Transaction.</li>
<li>Balances of each of the accounts not assigned to <code>program_id</code> must be equal
to or greater after the Transaction than before the transaction.</li>
<li>All Instructions in the Transaction executed without a failure.</li>
</ol>
<a class="header" href="#entry-point-execution-of-the-program-involves-mapping-the-programs-public" id="entry-point-execution-of-the-program-involves-mapping-the-programs-public"><h2>Entry Point Execution of the program involves mapping the Program's public</h2></a>
<p>key to an entry point which takes a pointer to the transaction, and an array of
loaded pages.</p>
<a class="header" href="#system-interface" id="system-interface"><h2>System Interface</h2></a>
<p>The interface is best described by the <code>Instruction::userdata</code> that the
user encodes.</p>
<ul>
<li><code>CreateAccount</code> - This allows the user to create and assign an Account to a
Program.</li>
<li><code>Assign</code> - allows the user to assign an existing account to a <code>Program</code>.</li>
<li><code>Move</code>  - moves tokens between <code>Account</code>s that are associated with
<code>SystemProgram</code>.  This cannot be used to move tokens of other <code>Account</code>s.
Programs need to implement their own version of Move.</li>
</ul>
<a class="header" href="#notes" id="notes"><h2>Notes</h2></a>
<ol>
<li>There is no dynamic memory allocation.  Client's need to call the
<code>SystemProgram</code> to create memory before passing it to another program.  This
Instruction can be composed into a single Transaction with the call to the
program itself.</li>
<li>Runtime guarantees that when memory is assigned to the <code>Program</code> it is zero
initialized.</li>
<li>Runtime guarantees that <code>Program</code>'s code is the only thing that can modify
memory that its assigned to</li>
<li>Runtime guarantees that the <code>Program</code> can only spend tokens that are in
<code>Account</code>s that are assigned to it</li>
<li>Runtime guarantees the balances belonging to <code>Account</code>s are balanced before
and after the transaction</li>
<li>Runtime guarantees that multiple instructions all executed successfully when
a transaction is committed.</li>
</ol>
<a class="header" href="#future-work" id="future-work"><h1>Future Work</h1></a>
<ul>
<li><a href="https://github.com/solana-labs/solana/issues/1485">Continuations and Signals for long running
Transactions</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="programs.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="ledger.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="programs.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="ledger.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
